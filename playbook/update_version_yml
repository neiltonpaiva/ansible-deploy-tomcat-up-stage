---
- name: "Deploy Version Updates - Ubuntu Environment (webapps, Datasul-report, lib) - Preservando custom + custom_fsw"
  hosts: frontend_servers
  serial: 1  # Um servidor Ubuntu por vez para updates de vers√£o
  gather_facts: yes
  vars:
    deploy_timestamp: "{{ ansible_date_time.epoch }}"
    deploy_date: "{{ ansible_date_time.date }}"
    update_source: "{{ fsx_mount }}/staging"
    
  pre_tasks:
    - name: "Verificar OS (deve ser Ubuntu)"
      fail:
        msg: "Este playbook √© espec√≠fico para Ubuntu. OS detectado: {{ ansible_distribution }}"
      when: ansible_distribution != "Ubuntu"
      
    - name: "Validar sources dos updates"
      stat:
        path: "{{ update_source }}/{{ item }}"
      register: version_sources
      loop:
        - webapps
        - Datasul-report
        - lib
      delegate_to: localhost
      run_once: true
      
    - name: "Verificar se todos os sources existem"
      fail:
        msg: "Source n√£o encontrado: {{ update_source }}/{{ item.item }}"
      loop: "{{ version_sources.results }}"
      when: not item.stat.exists
      delegate_to: localhost
      run_once: true

    - name: "Verificar espa√ßo em disco para version update"
      shell: |
        available=$(df {{ tomcat_home }} | tail -1 | awk '{print $4}')
        required=2097152  # 2GB em KB
        if [ $available -lt $required ]; then
          echo "INSUFFICIENT_SPACE"
        else
          echo "OK"
        fi
      register: disk_space_check
      become: yes
      
    - name: "Falhar se espa√ßo insuficiente"
      fail:
        msg: "Espa√ßo em disco insuficiente para update de vers√£o"
      when: disk_space_check.stdout == "INSUFFICIENT_SPACE"

    - name: "Confirma√ß√£o de deploy de vers√£o Ubuntu"
      pause:
        prompt: |
          ==========================================
          ATEN√á√ÉO: DEPLOY DE VERS√ÉO COMPLETA UBUNTU
          ==========================================
          Servidor: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          Diret√≥rios que ser√£o atualizados:
          - {{ tomcat_home }}/webapps
          - {{ tomcat_home }}/Datasul-report  
          - {{ tomcat_home }}/lib
          
          Diret√≥rios preservados:
          - {{ tomcat_home }}/webapps/custom
          - {{ tomcat_home }}/webapps/custom_fsw
          
          Continuar? (Ctrl+C para cancelar)
      when: inventory_hostname == play_hosts[0]  # S√≥ pergunta uma vez

  tasks:
    - name: "Coletar informa√ß√µes detalhadas do Ubuntu"
      setup:
        filter: "ansible_distribution*,ansible_kernel,ansible_memtotal_mb,ansible_processor*"
      
    - name: "Exibir informa√ß√µes completas do servidor"
      debug:
        msg: |
          ==========================================
          INFORMA√á√ïES DO SERVIDOR UBUNTU
          ==========================================
          Hostname: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          CPU: {{ ansible_processor_vcpus }} vCPUs
          Mem√≥ria: {{ ansible_memtotal_mb }}MB
          ==========================================

    - name: "Verificar diret√≥rios custom existentes antes do deploy"
      shell: |
        echo "=== Diret√≥rios Custom Pr√©-Deploy ==="
        custom_found=""
        if [ -d "{{ tomcat_home }}/webapps/custom" ]; then
          custom_size=$(du -sh {{ tomcat_home }}/webapps/custom | cut -f1)
          custom_files=$(find {{ tomcat_home }}/webapps/custom -type f | wc -l)
          echo "‚úì custom: $custom_size ($custom_files arquivos)"
          custom_found="custom "
        else
          echo "‚úó custom: n√£o existe"
        fi
        
        if [ -d "{{ tomcat_home }}/webapps/custom_fsw" ]; then
          custom_fsw_size=$(du -sh {{ tomcat_home }}/webapps/custom_fsw | cut -f1)
          custom_fsw_files=$(find {{ tomcat_home }}/webapps/custom_fsw -type f | wc -l)
          echo "‚úì custom_fsw: $custom_fsw_size ($custom_fsw_files arquivos)"
          custom_found="${custom_found}custom_fsw "
        else
          echo "‚úó custom_fsw: n√£o existe"
        fi
        
        if [ -z "$custom_found" ]; then
          echo "‚ÑπÔ∏è Nenhum diret√≥rio custom encontrado para preservar"
        else
          echo "üîí Ser√£o preservados: $custom_found"
        fi
      become: yes
      register: pre_deploy_custom_check
      
    - name: "Log da verifica√ß√£o pr√©-deploy"
      debug:
        msg: "{{ pre_deploy_custom_check.stdout }}"

    - name: "Criar diret√≥rio de backup para vers√£o"
      file:
        path: "{{ backup_base_dir }}/version/{{ deploy_date }}"
        state: directory
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_user }}"
        mode: '0755'
      become: yes

    - name: "Parar Tomcat para update de vers√£o (Ubuntu)"
      systemd:
        name: "{{ tomcat_service }}"
        state: started
        enabled: yes
        daemon_reload: yes
      become: yes
      register: version_tomcat_start
      
    - name: "Aguardar inicializa√ß√£o completa (vers√£o nova pode demorar mais)"
      wait_for:
        port: "{{ tomcat_port }}"
        timeout: 900  # 15 minutos para vers√£o nova
        delay: 15
        
    - name: "Monitorar logs de inicializa√ß√£o (Ubuntu)"
      shell: |
        echo "Monitorando logs de startup..."
        timeout 600 tail -f {{ tomcat_log_file }} | while read line; do
          echo "$line"
          # Condi√ß√µes de sucesso
          if echo "$line" | grep -q "Server startup in"; then
            echo "=== STARTUP COMPLETO ==="
            break
          fi
          # Condi√ß√µes de erro
          if echo "$line" | grep -q "SEVERE\|Exception\|Error"; then
            echo "=== POSS√çVEL ERRO DETECTADO ==="
          fi
        done 2>/dev/null || echo "Timeout no monitoramento de logs"
      become: yes
      register: startup_monitoring
      
    - name: "Health check extensivo para nova vers√£o (Ubuntu)"
      uri:
        url: "https://{{ ansible_default_ipv4.address }}:{{ tomcat_port }}/totvs-menu"
        method: GET
        status_code: [200, 302, 301]
        timeout: 60
        validate_certs: no
        follow_redirects: yes
      register: version_health_check
      retries: 20
      delay: 30
      ignore_errors: yes
      
    - name: "Teste adicional de conectividade (Ubuntu curl)"
      shell: |
        echo "=== Teste de Conectividade ==="
        curl -k -s -o /dev/null -w "Status: %{http_code}, Time: %{time_total}s\n" \
          "https://{{ ansible_default_ipv4.address }}:{{ tomcat_port }}/totvs-menu" || echo "Curl falhou"
        
        echo ""
        echo "=== Portas Abertas ==="
        ss -tlnp | grep :{{ tomcat_port }} || echo "Porta n√£o est√° em listening"
      register: connectivity_test
      
    - name: "Verificar logs de erro p√≥s-deploy"
      shell: |
        echo "=== √öltimos Erros nos Logs ==="
        tail -50 {{ tomcat_log_file }} | grep -i "error\|exception\|severe\|failed" | tail -10 || echo "Nenhum erro recente"
        
        echo ""
        echo "=== Status dos Servi√ßos ==="
        systemctl status {{ tomcat_service }} --no-pager -l
      become: yes
      register: post_deploy_check
      
    - name: "Verifica√ß√£o final completa dos diret√≥rios custom"
      shell: |
        echo "=== VERIFICA√á√ÉO FINAL CUSTOM DIRECTORIES ==="
        custom_status=""
        
        if [ -d "{{ tomcat_home }}/webapps/custom" ]; then
          custom_size=$(du -sh {{ tomcat_home }}/webapps/custom | cut -f1)
          custom_files=$(find {{ tomcat_home }}/webapps/custom -type f | wc -l)
          echo "‚úÖ custom: $custom_size ($custom_files arquivos) - PRESERVADO"
          custom_status="custom:OK "
        else
          echo "‚ùå custom: N√ÉO ENCONTRADO"
          custom_status="custom:MISSING "
        fi
        
        if [ -d "{{ tomcat_home }}/webapps/custom_fsw" ]; then
          custom_fsw_size=$(du -sh {{ tomcat_home }}/webapps/custom_fsw | cut -f1)
          custom_fsw_files=$(find {{ tomcat_home }}/webapps/custom_fsw -type f | wc -l)
          echo "‚úÖ custom_fsw: $custom_fsw_size ($custom_fsw_files arquivos) - PRESERVADO"
          custom_status="${custom_status}custom_fsw:OK"
        else
          echo "‚ùå custom_fsw: N√ÉO ENCONTRADO"
          custom_status="${custom_status}custom_fsw:MISSING"
        fi
        
        echo "Status final: $custom_status"
      become: yes
      register: final_custom_verification
      
    - name: "Relat√≥rio completo de deploy de vers√£o Ubuntu (com custom/custom_fsw)"
      debug:
        msg: |
          ===============================================
          DEPLOY DE VERS√ÉO COMPLETO - {{ inventory_hostname }}
          ===============================================
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          üìÅ BACKUPS CRIADOS:
          - Full: {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_full_backup_{{ deploy_timestamp }}.tar.gz
          - Custom Details: {{ custom_backup.stdout }}
          
          üöÄ STATUS DO DEPLOY:
          - Tomcat Stop: {{ 'OK' if version_tomcat_stop.changed else 'ERRO' }}
          - Tomcat Start: {{ 'OK' if version_tomcat_start.changed else 'ERRO' }}
          - Health Check: {{ 'OK' if version_health_check.status == 200 else 'VERIFICAR - Status: ' + (version_health_check.status | string) }}
          
          üîß SINCRONIZA√á√ïES:
          - Webapps: {{ 'OK' if webapps_sync.changed else 'SEM ALTERA√á√ïES' }}
          - Datasul-report: {{ 'OK' if datasul_sync.changed else 'SEM ALTERA√á√ïES' }}
          - Lib: {{ 'OK' if lib_sync.changed else 'SEM ALTERA√á√ïES' }}
          
          üîí PRESERVA√á√ÉO CUSTOM:
          {{ final_custom_verification.stdout }}
          
          üß™ TESTES DE CONECTIVIDADE:
          {{ connectivity_test.stdout }}
          
          üìã PR√ìXIMOS PASSOS:
          1. ‚úÖ Testar funcionalidades principais da aplica√ß√£o
          2. ‚úÖ Verificar se custom/custom_fsw funcionam corretamente
          3. ‚úÖ Verificar integra√ß√£o com load balancer
          4. ‚úÖ Monitorar logs por algumas horas
          5. ‚úÖ Validar performance da aplica√ß√£o
          
          ‚è∞ Timestamp: {{ deploy_timestamp }}
          ===============================================

  post_tasks:
    - name: "Criar relat√≥rio detalhado de deploy em arquivo"
      copy:
        content: |
          DEPLOY REPORT - VERSION UPDATE - {{ inventory_hostname }}
          =======================================================
          Date: {{ ansible_date_time.iso8601 }}
          Type: VERSION UPDATE (FULL)
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          
          BACKUPS CREATED:
          - Full: {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_full_backup_{{ deploy_timestamp }}.tar.gz
          - Custom backups: {{ custom_backup.stdout }}
          
          CUSTOM DIRECTORIES STATUS:
          {{ final_custom_verification.stdout }}
          
          HEALTH CHECK: {{ version_health_check.status | default('FAILED') }}
          
          PRE-DEPLOY CUSTOM STATUS:
          {{ pre_deploy_custom_check.stdout }}
          
          CUSTOM RESTORE STATUS:
          {{ custom_restore.stdout }}
          
          POST-DEPLOYMENT CHECKS:
          {{ post_deploy_check.stdout }}
          
          STARTUP MONITORING:
          {{ startup_monitoring.stdout }}
          
        dest: "{{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_deploy_report_{{ deploy_timestamp }}.txt"
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_user }}"
        mode: '0644'
      become: yes
      
    - name: "Log final do deploy de vers√£o"
      lineinfile:
        path: "{{ fsx_mount }}/logs/deploy-history.log"
        line: "{{ ansible_date_time.iso8601 }} - VERSION Deploy - {{ inventory_hostname }} - {{ 'SUCCESS' if version_health_check.status == 200 else 'NEEDS_CHECK' }} - custom+custom_fsw preserved"
        create: yes
      delegate_to: localhost
      run_once: true

    - name: "Notifica√ß√£o final com status custom"
      debug:
        msg: |
          üéâ DEPLOY DE VERS√ÉO FINALIZADO!
          
          {{ final_custom_verification.stdout }}
          
          ‚ö†Ô∏è  IMPORTANTE:
          - Teste a aplica√ß√£o completamente antes de prosseguir
          - VERIFIQUE se custom e custom_fsw est√£o funcionando
          - Monitore logs por pelo menos 1 hora
          - Em caso de problemas, execute rollback imediatamente
          - Backup completo dispon√≠vel para rollback de emerg√™ncia
          
          üìÑ Relat√≥rio detalhado salvo em:
          {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_deploy_report_{{ deploy_timestamp }}.txt
        state: stopped
      become: yes
      register: version_tomcat_stop
      
    - name: "Aguardar Tomcat parar completamente"
      wait_for:
        port: "{{ tomcat_port }}"
        state: stopped
        timeout: 120

    - name: "Verificar e encerrar processos restantes (Ubuntu)"
      shell: |
        pids=$(pgrep -f "{{ tomcat_home }}")
        if [ -n "$pids" ]; then
          echo "Encerrando processos restantes: $pids"
          kill -15 $pids
          sleep 10
          # Force kill se ainda existir
          remaining=$(pgrep -f "{{ tomcat_home }}")
          if [ -n "$remaining" ]; then
            echo "Force killing: $remaining"
            kill -9 $remaining
          fi
        else
          echo "Nenhum processo Tomcat encontrado"
        fi
      become: yes

    - name: "Backup completo da vers√£o atual"
      shell: |
        cd {{ tomcat_home }}
        echo "Criando backup completo..."
        tar -czf {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_full_backup_{{ deploy_timestamp }}.tar.gz \
          webapps Datasul-report lib
        
        # Verificar tamanho do backup
        backup_size=$(du -h {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_full_backup_{{ deploy_timestamp }}.tar.gz | cut -f1)
        echo "Backup completo criado: $backup_size"
      become: yes
      register: full_backup_result
      
    - name: "Log do backup completo"
      debug:
        msg: "{{ full_backup_result.stdout }}"
      
    - name: "Backup espec√≠fico dos diret√≥rios custom e custom_fsw"
      shell: |
        backup_created=""
        cd {{ tomcat_home }}/webapps
        
        # Backup do custom
        if [ -d "custom" ]; then
          tar -czf {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_custom_{{ deploy_timestamp }}.tar.gz custom/
          custom_size=$(du -h {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_custom_{{ deploy_timestamp }}.tar.gz | cut -f1)
          backup_created="custom($custom_size) "
          echo "‚úì Backup custom criado: $custom_size"
        else
          echo "‚úó custom n√£o existe para backup"
        fi
        
        # Backup do custom_fsw
        if [ -d "custom_fsw" ]; then
          tar -czf {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_custom_fsw_{{ deploy_timestamp }}.tar.gz custom_fsw/
          custom_fsw_size=$(du -h {{ backup_base_dir }}/version/{{ deploy_date }}/{{ inventory_hostname }}_custom_fsw_{{ deploy_timestamp }}.tar.gz | cut -f1)
          backup_created="${backup_created}custom_fsw($custom_fsw_size) "
          echo "‚úì Backup custom_fsw criado: $custom_fsw_size"
        else
          echo "‚úó custom_fsw n√£o existe para backup"
        fi
        
        if [ -n "$backup_created" ]; then
          echo "üîí Backups custom criados: $backup_created"
        else
          echo "‚ÑπÔ∏è Nenhum diret√≥rio custom para backup"
        fi
      become: yes
      register: custom_backup
      
    - name: "Limpar diret√≥rios atuais (preservando custom/custom_fsw temporariamente)"
      shell: |
        echo "üîí Preservando diret√≥rios custom temporariamente..."
        
        # Preservar custom temporariamente
        if [ -d "{{ tomcat_home }}/webapps/custom" ]; then
          echo "Movendo custom para /tmp/custom_temp_{{ deploy_timestamp }}"
          cp -r {{ tomcat_home }}/webapps/custom /tmp/custom_temp_{{ deploy_timestamp }}
          echo "‚úì custom preservado temporariamente"
        fi
        
        # Preservar custom_fsw temporariamente
        if [ -d "{{ tomcat_home }}/webapps/custom_fsw" ]; then
          echo "Movendo custom_fsw para /tmp/custom_fsw_temp_{{ deploy_timestamp }}"
          cp -r {{ tomcat_home }}/webapps/custom_fsw /tmp/custom_fsw_temp_{{ deploy_timestamp }}
          echo "‚úì custom_fsw preservado temporariamente"
        fi
        
        echo "üóëÔ∏è Limpando diret√≥rios para nova vers√£o..."
        rm -rf {{ tomcat_home }}/webapps/*
        rm -rf {{ tomcat_home }}/Datasul-report/*  
        rm -rf {{ tomcat_home }}/lib/*
        
        echo "‚úÖ Diret√≥rios limpos (custom/custom_fsw preservados temporariamente)"
      become: yes
      register: cleanup_result
      
    - name: "Log da limpeza"
      debug:
        msg: "{{ cleanup_result.stdout }}"
      
    - name: "Atualizar webapps (Ubuntu rsync)"
      synchronize:
        src: "{{ update_source }}/webapps/"
        dest: "{{ tomcat_home }}/webapps/"
        delete: yes
        rsync_opts:
          - "--chown={{ tomcat_user }}:{{ tomcat_user }}"
          - "--chmod=755"
        mode: push
      become: yes
      register: webapps_sync
      
    - name: "Atualizar Datasul-report (Ubuntu rsync)"
      synchronize:
        src: "{{ update_source }}/Datasul-report/"
        dest: "{{ tomcat_home }}/Datasul-report/"
        delete: yes
        rsync_opts:
          - "--chown={{ tomcat_user }}:{{ tomcat_user }}"
          - "--chmod=755"
        mode: push
      become: yes
      register: datasul_sync
      
    - name: "Atualizar lib (Ubuntu rsync)"
      synchronize:
        src: "{{ update_source }}/lib/"
        dest: "{{ tomcat_home }}/lib/"
        delete: yes
        rsync_opts:
          - "--chown={{ tomcat_user }}:{{ tomcat_user }}"
          - "--chmod=755"
        mode: push
      become: yes
      register: lib_sync
      
    - name: "Restaurar diret√≥rios custom e custom_fsw"
      shell: |
        restored=""
        
        # Restaurar custom
        if [ -d "/tmp/custom_temp_{{ deploy_timestamp }}" ]; then
          echo "Restaurando custom..."
          mv /tmp/custom_temp_{{ deploy_timestamp }} {{ tomcat_home }}/webapps/custom
          chown -R {{ tomcat_user }}:{{ tomcat_user }} {{ tomcat_home }}/webapps/custom
          chmod -R 755 {{ tomcat_home }}/webapps/custom
          custom_files=$(find {{ tomcat_home }}/webapps/custom -type f | wc -l)
          restored="custom($custom_files arquivos) "
          echo "‚úì custom restaurado com $custom_files arquivos"
        else
          echo "‚úó custom n√£o encontrado para restaurar"
        fi
        
        # Restaurar custom_fsw
        if [ -d "/tmp/custom_fsw_temp_{{ deploy_timestamp }}" ]; then
          echo "Restaurando custom_fsw..."
          mv /tmp/custom_fsw_temp_{{ deploy_timestamp }} {{ tomcat_home }}/webapps/custom_fsw
          chown -R {{ tomcat_user }}:{{ tomcat_user }} {{ tomcat_home }}/webapps/custom_fsw
          chmod -R 755 {{ tomcat_home }}/webapps/custom_fsw
          custom_fsw_files=$(find {{ tomcat_home }}/webapps/custom_fsw -type f | wc -l)
          restored="${restored}custom_fsw($custom_fsw_files arquivos) "
          echo "‚úì custom_fsw restaurado com $custom_fsw_files arquivos"
        else
          echo "‚úó custom_fsw n√£o encontrado para restaurar"
        fi
        
        if [ -n "$restored" ]; then
          echo "üéâ Diret√≥rios restaurados com sucesso: $restored"
        else
          echo "‚ÑπÔ∏è Nenhum diret√≥rio custom para restaurar"
        fi
      become: yes
      register: custom_restore
      
    - name: "Verificar arquivos atualizados"
      shell: |
        echo "=== Verifica√ß√£o da Nova Vers√£o ==="
        echo "Webapps:"
        ls -la {{ tomcat_home }}/webapps/ | head -10
        echo ""
        echo "Lib:"
        ls -la {{ tomcat_home }}/lib/ | head -5
        echo ""
        echo "Datasul-report:"
        ls -la {{ tomcat_home }}/Datasul-report/ | head -5
        echo ""
        echo "=== Custom Directories Status ==="
        if [ -d "{{ tomcat_home }}/webapps/custom" ]; then
          echo "‚úì custom: $(ls {{ tomcat_home }}/webapps/custom/ | wc -l) arquivos"
        else
          echo "‚úó custom: n√£o encontrado"
        fi
        if [ -d "{{ tomcat_home }}/webapps/custom_fsw" ]; then
          echo "‚úì custom_fsw: $(ls {{ tomcat_home }}/webapps/custom_fsw/ | wc -l) arquivos"
        else
          echo "‚úó custom_fsw: n√£o encontrado"
        fi
      become: yes
      register: files_verification
      
    - name: "Log da verifica√ß√£o de arquivos"
      debug:
        msg: "{{ files_verification.stdout }}"
      
    - name: "Definir permiss√µes finais (Ubuntu)"
      file:
        path: "{{ item }}"
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_user }}"
        mode: '0755'
        recurse: yes
      loop:
        - "{{ tomcat_home }}/webapps"
        - "{{ tomcat_home }}/Datasul-report"
        - "{{ tomcat_home }}/lib"
      become: yes
      
    - name: "Iniciar Tomcat ap√≥s update de vers√£o (Ubuntu)"
      systemd:
        name: "{{ tomcat_service }}"