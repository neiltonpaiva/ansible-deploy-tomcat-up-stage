---
- name: "Deploy WAR Updates - Estrutura Simples (preservando custom + custom_fsw)"
  hosts: frontend_servers
  serial: "{{ deployment_batch_size | default(2) }}"  # 2 servidores por vez
  gather_facts: yes
  vars:
    deploy_timestamp: "{{ ansible_date_time.epoch }}"
    deploy_date: "{{ ansible_date_time.date }}"
    war_source: "{{ fsx_mount }}/staging/war"  # â† DiretÃ³rio fixo
    
  pre_tasks:
    - name: "Validar se diretÃ³rio WAR existe"
      stat:
        path: "{{ war_source }}"
      register: war_dir
      delegate_to: localhost
      run_once: true
      
    - name: "Falhar se diretÃ³rio WAR nÃ£o existir"
      fail:
        msg: "DiretÃ³rio WAR nÃ£o encontrado: {{ war_source }}"
      when: not war_dir.stat.exists
      delegate_to: localhost
      run_once: true

    - name: "Verificar se hÃ¡ arquivos WAR no diretÃ³rio"
      find:
        paths: "{{ war_source }}"
        patterns: ["*.war", "*.WAR"]
      register: war_files
      delegate_to: localhost
      run_once: true
      
    - name: "Falhar se nÃ£o hÃ¡ WARs para deploy"
      fail:
        msg: "Nenhum arquivo .war ou .WAR encontrado em {{ war_source }}"
      when: war_files.files | length == 0
      delegate_to: localhost
      run_once: true

    - name: "Listar arquivos WAR encontrados"
      debug:
        msg: |
          Arquivos WAR encontrados para deploy:
          {% for file in war_files.files %}
          - {{ file.path | basename }} ({{ (file.size / 1024 / 1024) | round(2) }} MB)
          {% endfor %}
          Total: {{ war_files.files | length }} arquivo(s)

    - name: "Verificar espaÃ§o em disco disponÃ­vel"
      shell: df -h {{ tomcat_home }} | tail -1 | awk '{print $5}' | sed 's/%//'
      register: disk_usage
      become: yes
      
    - name: "Falhar se pouco espaÃ§o em disco"
      fail:
        msg: "EspaÃ§o em disco insuficiente: {{ disk_usage.stdout }}% usado"
      when: disk_usage.stdout | int > 85

  tasks:
    - name: "Coletar informaÃ§Ãµes do sistema"
      setup:
        filter: "ansible_distribution*,ansible_kernel,ansible_memtotal_mb"
      
    - name: "Exibir informaÃ§Ãµes do servidor"
      debug:
        msg: |
          Servidor: {{ inventory_hostname }}
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Kernel: {{ ansible_kernel }}
          MemÃ³ria: {{ ansible_memtotal_mb }}MB

    - name: "Verificar diretÃ³rios custom existentes"
      shell: |
        echo "=== DiretÃ³rios Custom Existentes ==="
        if [ -d "{{ tomcat_home }}/webapps/custom" ]; then
          echo "âœ“ custom: $(du -sh {{ tomcat_home }}/webapps/custom | cut -f1)"
        else
          echo "âœ— custom: nÃ£o existe"
        fi
        if [ -d "{{ tomcat_home }}/webapps/custom_fsw" ]; then
          echo "âœ“ custom_fsw: $(du -sh {{ tomcat_home }}/webapps/custom_fsw | cut -f1)"
        else
          echo "âœ— custom_fsw: nÃ£o existe"
        fi
      become: yes
      register: custom_dirs_check
      
    - name: "Log dos diretÃ³rios custom"
      debug:
        msg: "{{ custom_dirs_check.stdout }}"

    - name: "Criar diretÃ³rio de backup"
      file:
        path: "{{ backup_base_dir }}/{{ deploy_date }}"
        state: directory
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_user }}"
        mode: '0755'
      become: yes

    - name: "Verificar status inicial do Tomcat"
      systemd:
        name: "{{ tomcat_service }}"
      register: tomcat_initial_status
      become: yes

    - name: "Backup dos WARs atuais (case-insensitive)"
      shell: |
        cd {{ tomcat_home }}/webapps
        # Buscar tanto .war quanto .WAR
        war_files=$(find . -maxdepth 1 \( -name "*.war" -o -name "*.WAR" \) -not -path "./custom/*" -not -path "./custom_fsw/*" 2>/dev/null)
        if [ -n "$war_files" ]; then
          tar -czf {{ backup_base_dir }}/{{ deploy_date }}/{{ inventory_hostname }}_webapps_{{ deploy_timestamp }}.tar.gz \
            --exclude=custom \
            --exclude=custom_fsw \
            $war_files
          war_count=$(echo $war_files | wc -w)
          echo "Backup criado com $war_count arquivos WAR (preservando custom/custom_fsw)"
        else
          echo "Nenhum arquivo WAR/war encontrado para backup"
          # Criar backup vazio para consistÃªncia
          tar -czf {{ backup_base_dir }}/{{ deploy_date }}/{{ inventory_hostname }}_webapps_{{ deploy_timestamp }}.tar.gz --files-from /dev/null
        fi
      become: yes
      register: backup_result
      
    - name: "Log do backup"
      debug:
        msg: "{{ backup_result.stdout }}"
      
    - name: "Parar Tomcat gracefully"
      systemd:
        name: "{{ tomcat_service }}"
        state: stopped
      become: yes
      register: tomcat_stop
      
    - name: "Aguardar Tomcat parar completamente"
      wait_for:
        port: "{{ tomcat_port }}"
        state: stopped
        timeout: "{{ service_management.stop_timeout | default(60) }}"
        
    - name: "Verificar se processo Tomcat foi finalizado"
      shell: |
        pgrep -f "{{ tomcat_home }}" || echo "Nenhum processo Tomcat encontrado"
      register: tomcat_processes
      become: yes
      
    - name: "ForÃ§ar kill se necessÃ¡rio"
      shell: |
        pids=$(pgrep -f "{{ tomcat_home }}")
        if [ -n "$pids" ]; then
          echo "ForÃ§ando encerramento dos processos: $pids"
          kill -9 $pids
          sleep 5
        else
          echo "Nenhum processo para encerrar"
        fi
      become: yes
      when: tomcat_processes.stdout != "Nenhum processo Tomcat encontrado"
      
    - name: "Remover WARs antigos (preservando custom e custom_fsw - case-insensitive)"
      shell: |
        cd {{ tomcat_home }}/webapps
        
        # Log do que serÃ¡ preservado
        if [ -d "custom" ]; then
          echo "Preservando diretÃ³rio custom"
        fi
        if [ -d "custom_fsw" ]; then
          echo "Preservando diretÃ³rio custom_fsw"
        fi
        
        # Remover WARs (tanto .war quanto .WAR - excluindo custom e custom_fsw)
        find . -maxdepth 1 \( -name "*.war" -o -name "*.WAR" \) \
          -not -path "./custom/*" -not -path "./custom_fsw/*" -delete
        
        # Remover diretÃ³rios expandidos (exceto custom, custom_fsw e ROOT)
        find . -maxdepth 1 -type d \
          -not -name "custom" \
          -not -name "custom_fsw" \
          -not -name "ROOT" \
          -not -name "." \
          -exec rm -rf {} + 2>/dev/null || true
        
        echo "Limpeza concluÃ­da (custom e custom_fsw preservados)"
      become: yes

    - name: "Copiar novos WARs do FSx (case-insensitive)"
      shell: |
        echo "Copiando WARs de {{ war_source }} para {{ tomcat_home }}/webapps/"
        
        # Copiar tanto .war quanto .WAR
        cd {{ war_source }}
        for war_file in *.war *.WAR; do
          if [ -f "$war_file" ]; then
            echo "Copiando: $war_file"
            cp "$war_file" {{ tomcat_home }}/webapps/
          fi
        done 2>/dev/null || echo "Nenhum arquivo WAR para copiar"
        
        # Definir permissÃµes
        chown {{ tomcat_user }}:{{ tomcat_user }} {{ tomcat_home }}/webapps/*.war {{ tomcat_home }}/webapps/*.WAR 2>/dev/null || true
        chmod 644 {{ tomcat_home }}/webapps/*.war {{ tomcat_home }}/webapps/*.WAR 2>/dev/null || true
        
        echo "CÃ³pia concluÃ­da"
      become: yes
      register: copy_result
      
    - name: "Log da cÃ³pia"
      debug:
        msg: "{{ copy_result.stdout }}"
      
    - name: "Verificar arquivos copiados (case-insensitive)"
      shell: |
        cd {{ tomcat_home }}/webapps
        echo "Arquivos WAR apÃ³s cÃ³pia:"
        # Listar tanto .war quanto .WAR
        war_list=$(ls *.war *.WAR 2>/dev/null || echo "")
        if [ -n "$war_list" ]; then
          ls -la *.war *.WAR 2>/dev/null
        else
          echo "ERRO: Nenhum arquivo WAR encontrado apÃ³s cÃ³pia!"
        fi
        
        # Contar todos os WARs
        war_count=$(find . -maxdepth 1 \( -name "*.war" -o -name "*.WAR" \) | wc -l)
        echo "Total de WARs: $war_count"
        echo ""
        echo "DiretÃ³rios preservados:"
        if [ -d "custom" ]; then
          echo "âœ“ custom: $(du -sh custom | cut -f1)"
        fi
        if [ -d "custom_fsw" ]; then
          echo "âœ“ custom_fsw: $(du -sh custom_fsw | cut -f1)"
        fi
      become: yes
      register: war_count
      
    - name: "Log da verificaÃ§Ã£o"
      debug:
        msg: "{{ war_count.stdout }}"
      
    - name: "Definir permissÃµes corretas"
      file:
        path: "{{ tomcat_home }}/webapps"
        owner: "{{ tomcat_user }}"
        group: "{{ tomcat_user }}"
        mode: '0755'
        recurse: yes
      become: yes
      
    - name: "Iniciar Tomcat"
      systemd:
        name: "{{ tomcat_service }}"
        state: started
        enabled: yes
        daemon_reload: yes
      become: yes
      register: tomcat_start
      
    - name: "Aguardar Tomcat inicializar"
      wait_for:
        port: "{{ tomcat_port }}"
        timeout: "{{ deploy_timeout }}"
        delay: 10
        
    - name: "Aguardar deploy dos WARs (monitoring logs)"
      shell: |
        timeout 300 tail -f {{ tomcat_log_file }} | while read line; do
          echo "$line"
          echo "$line" | grep -q "Deployment of web application" && break
          echo "$line" | grep -q "Server startup in" && break
        done 2>/dev/null || echo "Timeout aguardando deploy"
      become: yes
      register: war_deployment
      
    - name: "Health check da aplicaÃ§Ã£o"
      uri:
        url: "https://{{ ansible_default_ipv4.address }}:{{ tomcat_port }}/totvs-menu"
        method: GET
        status_code: [200, 302, 301]  # Aceitar redirecionamentos
        timeout: 30
        validate_certs: no
        follow_redirects: yes
      register: health_check_result
      retries: "{{ health_check_retries }}"
      delay: "{{ health_check_delay }}"
      ignore_errors: yes
      
    - name: "Verificar logs de erro no Tomcat"
      shell: |
        tail -100 {{ tomcat_log_file }} | grep -i "error\|exception\|failed\|severe" | tail -5 || echo "Nenhum erro recente encontrado"
      become: yes
      register: tomcat_errors
      ignore_errors: yes
      
    - name: "RelatÃ³rio de deploy completo"
      debug:
        msg: |
          ===============================================
          DEPLOY WAR COMPLETO - {{ inventory_hostname }}
          ===============================================
          OS: {{ ansible_distribution }} {{ ansible_distribution_version }}
          Status Tomcat: {{ 'OK' if tomcat_start.changed else 'ERRO' }}
          Health Check: {{ 'OK' if health_check_result.status == 200 else 'ALERTA - Status: ' + (health_check_result.status | string) }}
          Backup: {{ backup_base_dir }}/{{ deploy_date }}/{{ inventory_hostname }}_webapps_{{ deploy_timestamp }}.tar.gz
          Source: {{ war_source }}
          Arquivos: {{ war_files.files | length }} WARs
          Timestamp: {{ deploy_timestamp }}
          
          ðŸ”’ Custom preservados: custom + custom_fsw
          ðŸ“¦ Deploy: Estrutura simples FSx
          
          {% if tomcat_errors.stdout and tomcat_errors.stdout != "Nenhum erro recente encontrado" %}
          âš ï¸ Erros encontrados nos logs:
          {{ tomcat_errors.stdout }}
          {% endif %}
          ===============================================

  post_tasks:
    - name: "Limpeza de backups antigos"
      find:
        paths: "{{ backup_base_dir }}"
        age: "{{ backup_retention_days }}d"
        file_type: file
        patterns: "*.tar.gz"
      register: old_backups
      become: yes
      
    - name: "Remover backups antigos"
      file:
        path: "{{ item.path }}"
        state: absent
      loop: "{{ old_backups.files }}"
      become: yes
      when: old_backups.files is defined and old_backups.files | length > 0
      
    - name: "Log final do deploy"
      lineinfile:
        path: "{{ fsx_mount }}/logs/deploy-history.log"
        line: "{{ ansible_date_time.iso8601 }} - WAR Deploy - {{ inventory_hostname }} - SUCCESS - simple structure - {{ war_files.files | length }} files"
        create: yes
      delegate_to: localhost
      run_once: true